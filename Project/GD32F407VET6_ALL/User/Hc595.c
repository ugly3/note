#include "Hc595.h"


void HC595_Init(void)
{
	rcu_periph_clock_enable(RCLK_RTC);
	rcu_periph_clock_enable(SCLK_RTC);
	rcu_periph_clock_enable(SER_RTC);
	rcu_periph_clock_enable(OE_RTC);
	
	gpio_mode_set(RCLK_GPIO_Port, GPIO_MODE_OUTPUT, GPIO_PUPD_PULLDOWN, RCLK_Pin);
	gpio_mode_set(SCLK_GPIO_Port, GPIO_MODE_OUTPUT, GPIO_PUPD_PULLDOWN, SCLK_Pin);
	gpio_mode_set(SER_GPIO_Port, GPIO_MODE_OUTPUT, GPIO_PUPD_PULLDOWN, SER_Pin);
	gpio_mode_set(OE_GPIO_Port, GPIO_MODE_OUTPUT, GPIO_PUPD_PULLDOWN, OE_Pin);
	
    
	gpio_output_options_set(RCLK_GPIO_Port, GPIO_OTYPE_PP, GPIO_OSPEED_50MHZ, RCLK_Pin);//输出
	gpio_output_options_set(SCLK_GPIO_Port, GPIO_OTYPE_PP, GPIO_OSPEED_50MHZ, SCLK_Pin);//将数据移入移位寄存器
	gpio_output_options_set(SER_GPIO_Port, GPIO_OTYPE_PP, GPIO_OSPEED_50MHZ, SER_Pin);//输入脚位
	gpio_output_options_set(OE_GPIO_Port, GPIO_OTYPE_PP, GPIO_OSPEED_50MHZ, OE_Pin);
	
	gpio_bit_write(OE_GPIO_Port, OE_Pin, RESET);
	
	RCLK_L;
	SCLK_L;
	SER_L;
	delay_1ms(500);
}

void HC595_Send_16Bit(uint16_t data) 
{  
	uint16_t i = 0;
	for(i=0;i<16;i++)           	
	{ 
	    if((data & 0x8000) == 0X8000)
		{
			SER_H;
		}
		else
		{
			SER_L;  
		}
		delay_1us(10);
		SCLK_L; 
		delay_1us(10);
		SCLK_H; 	                //移位输入时钟，上升沿输入 
		delay_1us(10);
		data <<=1;
 	} 
	RCLK_L;         
	delay_1us(10);            			//并行输出时钟 对消隐会起作用     
	RCLK_H;
}

uint16_t HC595_Dat_Handle(uint8_t dat,uint8_t cnt)//处理成从右至左扫描，数据高位在上
{
	uint16_t  Rt = 0;
	Rt = cnt;
	Rt <<= 8;
	Rt |= (uint8_t)(~dat);
	return Rt;
}

void HC595_OUT(uint8_t* data)
{
	uint8_t i = 0;
	uint16_t dat = 0;
	for(i=0;i<8;i++)
	{
		dat = HC595_Dat_Handle(*(data+i),1<<i);
		HC595_Send_16Bit(dat);
	}
}

//*******************************16*16**********************************************

//列扫描数据数组
unsigned short Data_L[32] = {  0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //第一个行管HC595
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80};//第二个行管HC595

 /* 位选 */
void HC595_Send_Data(unsigned char dat)
{
    unsigned char i;
    for(i = 0; i < 8; i++)
    {
        if( ( dat << i ) & 0x80)
        {
            SER_H;
        }
        else
        {
            SER_L;
        }
        SCLK_L;
        delay_1us(2);
        SCLK_H;
    }
}

/* 输出全部数据 */
void HC595_Out(void)
{
    RCLK_L;
    delay_1us(2);
    RCLK_H;
}

/* 从右往左滚动显示 */
void Matrix_LED_RIGHT_LEFT_Run_Display(unsigned char *data, unsigned int len)
{
    static unsigned int cnt = 0;
    unsigned char i,k;
    unsigned char j = 0;
    for(k = 0; k < 200; k++)//控制变换字符的速度，循环次数越多，滚动越慢
    {
        for(i = 0; i < 16; i++)//即点阵输出一个完整界面
        {
            HC595_Send_Data(~Data_L[i+16]);//2组8位，组成16位一行，扫描16列，控制一列的灯高低电平。
            HC595_Send_Data(~Data_L[i]);
            
            HC595_Send_Data(~data[j+1+cnt]);//2组8位，组成16位一列，扫描16行，控制当前固定列的每一行的灯是否亮灭
            HC595_Send_Data(~data[j+cnt]);
            
            HC595_Out();//HC595的8个引脚开始输出电平，每一行开始被执行点亮或熄灭
            j += 2;
        }
        j = 0;
    }
    cnt += 2;//+2字表示data数组就会执行掉俩个数，即字会向左平移一列
    if(cnt > len-32)//表示执行到最后一个字时，下一个轮到显示的字马上为第一个字
        cnt=0;
}


/*16*16从右往左扫描显示数组  点阵格式：阳码；取模走向：逆向；取模方式：逐列式 */
unsigned char DZLL[224] = {
    
0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,
0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0xFF,0xFF,/*"一",0*/

0xFF,0xFF,0x07,0x00,0xFE,0xFF,0xFD,0xFF,0xFF,0xF7,0xFD,0xFB,0xFD,0xFC,0x0D,0xFF,
0xFD,0xFE,0xFD,0xFD,0xFD,0xF3,0xFD,0xBF,0xFD,0x7F,0x01,0x80,0xFF,0xFF,0xFF,0xFF,/*"闪",1*/

0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,
0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0x7F,0xFF,0xFF,0xFF,/*"一",2*/

0xFF,0xFF,0x07,0x00,0xFE,0xFF,0xFD,0xFF,0xFF,0xF7,0xFD,0xFB,0xFD,0xFC,0x0D,0xFF,
0xFD,0xFE,0xFD,0xFD,0xFD,0xF3,0xFD,0xBF,0xFD,0x7F,0x01,0x80,0xFF,0xFF,0xFF,0xFF,/*"闪",3*/

0xFF,0x7B,0xFB,0x7C,0xFB,0xBE,0x8B,0xDE,0xAB,0xE2,0xAB,0xFA,0xAA,0xFA,0xA9,0xFA,
0xAB,0xFA,0xAB,0xFA,0xAB,0x82,0x8B,0x7E,0xFB,0x7E,0xFB,0x7A,0xFF,0x1C,0xFF,0xFF,/*"亮",4*/

0xFF,0xFF,0xFF,0xBB,0xFF,0xBD,0x41,0xB6,0xD5,0xB6,0xD5,0xB6,0xD5,0xB6,0x15,0x80,
0xD5,0xB6,0xD5,0xB6,0xD5,0xB6,0xC1,0xB6,0xFF,0xBE,0xFF,0xBF,0xFF,0xFF,0xFF,0xFF,/*"星",5*/

0xFF,0xFF,0xFF,0xBB,0xFF,0xBD,0x41,0xB6,0xD5,0xB6,0xD5,0xB6,0xD5,0xB6,0x15,0x80,
0xD5,0xB6,0xD5,0xB6,0xD5,0xB6,0xC1,0xB6,0xFF,0xBE,0xFF,0xBF,0xFF,0xFF,0xFF,0xFF,/*"星",6*/
};

uint8_t love[8]= { 0x30,0x78,0x7C,0x3E,0x3E,0x7C,0x78,0x30};
